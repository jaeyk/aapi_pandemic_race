---
title: "Descriptive analysis (subgroup)"
author: "Jae Yeon Kim"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

# Load packages 

```{r}
if (!require(pacman)) install.packages("pacman")

pacman::p_load(
  tidyverse, # tidyverse
  panelr, # panel data analysis
  here, # computational reproducibility
  glue, # gluing objects and strings
  tidylog, # logging analysis
  naniar, # missing data
  readxl,
  ggpubr,
  broom,
  patchwork,
  plm,
  broom.mixed,
  estimatr,
  DeclareDesign,
  sensemakr,
  mice,
  testthat,
  modelsummary
)

source(here("functions/utils.r"))
source(here("functions/theme.R"))

ggplot2::theme_set(theme_bw())

# no scientific notation
options(scipen = 999)
```

# Load files 

```{r message = FALSE}
df <- read_csv(here("processed_data", "panel_data_cleaned.csv"))
```

# Subgroup partition 

```{r}
# create a proxy variable
df$proxy <- rep(subset(df, wave == 1)$gendiscrim, 3)

test_that("Proxy setting done correctly", {
  expect_equal(table(df$proxy)[5] %>% as.numeric(), 186)
})

df$prior[df$proxy == 0.5] <- "Middle"
df$prior[df$proxy < 0.5] <- "Low"
df$prior[df$proxy > 0.5] <- "High"

# factorize

df <- df %>% 
  mutate(prior = fct_relevel(prior, levels = c("Low", "Middle", "High")))

## covariates
df$wave <- factor(df$wave)
```

# Visualize correlation matrix

```{r}
biden_total_plot <- df %>%
  filter(wave_fac %in% c("May", "November")) %>%
  group_by(wave_fac) %>%
  summarize(biden_support = mean(biden, na.rm = T)) %>%
  ggplot(aes(x = glue("{factor(wave_fac)} 2020"), y = round(biden_support, 2)*100)) +
  geom_col(position = "dodge2") +  
  ggrepel::geom_text_repel(aes(label = paste0(round(biden_support, 2)*100, "%"))) +
  labs(y = "Biden support (%)", x = "") +
  theme(legend.position = "bottom") +
  scale_y_continuous(labels = ~paste0(., "%")) 
```

```{r}
biden_sub_plot <- df %>%
  filter(wave_fac %in% c("May", "November")) %>%
  group_by(prior, wave_fac) %>%
  summarize(biden_support = mean(biden, na.rm = T)) %>%
  ggplot(aes(x = glue("{factor(wave_fac)} 2020"), y = round(biden_support, 2)*100, shape = prior)) +
  geom_point(size = 3) +  
  geom_line(aes(group = prior)) +
  labs(y = "Biden support (%)", x = "",
       shape = "Pre-pandemic discrimination") +
  theme(legend.position = "bottom") +
  ggrepel::geom_text_repel(aes(label = paste0(round(biden_support, 2)*100, "%"))) +
  scale_y_continuous(labels = ~paste0(., "%")) 
```

```{r}
cor_plot <- df %>% 
  filter(wave_fac %in% c("May", "November")) %>%
  group_by(prior, wave_fac) %>%
  summarize("COVID-19 discrimination" = cor(biden, apa.discrim.rona, use = "complete.obs"),
            "Democratic partisanship" = cor(biden, DEM, use = "complete.obs")) %>%
  pivot_longer(cols = matches("COVID|Democratic"),
               names_to = "variables",
               values_to = "corr_coefs") %>%
  ggplot(aes(x = glue("{factor(wave_fac)} 2020"), y = corr_coefs, fill = variables)) +
  geom_col(position = "dodge2") +
  facet_wrap(~prior) +
  labs(y = "Correlation coefficient (r)", x = "",
       fill = "Correlation variables") +
  theme(legend.position = "bottom")
```

```{r}
(biden_total_plot + biden_sub_plot) / cor_plot + plot_annotation(tag_levels = "A") 

ggsave(here("outputs", "fig1_desc.png"), width = 10, height = 8)

subset(df, wave == 1)$prior %>% table()
```

High = 199, Low = 204, Middle = 261

# Data summaries 

```{r}
datasummary_balance(
  ~prior,
  data = df %>%
    filter(wave == 1) %>%
    select(income, edu, usborn, party.id, chinese, indian, prior),
  output = "gt"
  )
```