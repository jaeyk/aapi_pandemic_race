---
title: "Descriptive analysis"
author: "Jae Yeon Kim"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

# Load packages 

```{r}
if (!require(pacman)) install.packages("pacman")

pacman::p_load(tidyverse, # tidyverse 
               panelr, # panel data analysis
               here, # computational reproducibility 
               glue, # gluing objects and strings 
               tidylog, # logging analysis
               naniar, # missing data 
               zeallot, # multiple assignments 
               readxl, 
               ggpubr, 
               broom, 
               patchwork, 
               plm, 
               broom.mixed, 
               estimatr, 
               stargazer)

# for publication-friendly theme 
theme_set(theme_pubr())

source(here("functions/utils.r"))
```

# Load files 

```{r message = FALSE}
df <- read.csv(here("processed_data", "panel_data_cleaned.csv"))
```

# Extra munging

```{r}
# Reverse code 
c(df$apa.discrim.rona, df$gendiscrim, df$linkedfate, df$trump.approve, df$trump.approve, df$apa.responsible, df$apa.have.rona, df$apa.harassment, df$idimport, df$asnpride, df$X2020likelyvote) %<-% map(list(df$apa.discrim.rona, df$gendiscrim, df$linkedfate, df$trump.approve, df$trump.approve, df$apa.responsible, df$apa.have.rona, df$apa.harassment, df$idimport, df$asnpride, df$X2020likelyvote), reverse)

# Normalize 
c(df$apa.discrim.rona, df$gendiscrim, df$linkedfate, df$trump.approve, df$age, df$edu, df$apa.responsible, df$apa.have.rona, df$apa.harassment, df$idimport, df$asnpride, df$X2020likelyvote) %<-% map(list(df$apa.discrim.rona, df$gendiscrim, df$linkedfate, df$trump.approve, df$age, df$edu, df$apa.responsible, df$apa.have.rona, df$apa.harassment, df$idimport, df$asnpride, df$X2020likelyvote), rescale01)

# Factorize (categorical variables)
df$natorigin <- factor(df$natorigin)
df$usborn <- factor(df$usborn)
df$male <- factor(df$male)
df$party.id <- factor(df$party.id)
df$state <- factor(df$state)
df$biden <- if_else(!is.na(df$X2020likelycand) & df$X2020likelycand == 1, 1, 0)

subset(df, wave == 2)$gendiscrim[1:5]
subset(df, wave == 2)$X2020likelyvote[1:5]
```

```{r}
# Add factor version wave variable
df$wave_fac <- recode(as.character(df$wave), 
                  "1" = "February",
       "2" = "May",
       "3" = "November") 

df$wave_fac <- factor(df$wave_fac, levels = c("February", "May", "November"))

# Check
subset(df, wave == 2)$gendiscrim[1:5]
subset(df, wave == 2)$X2020likelyvote[1:5]

# Additional dummies 
df$DEM <- if_else(df$party.id == "Democrat", 1, 0)
df$DEM.strong <- if_else(df$party.id == "Democrat" & df$partystr == 1, 1, 0)

df$GOP <- if_else(df$party.id == "Republican", 1, 0)
df$GOP.strong <- if_else(df$party.id == "Republican" & df$partystr == 1, 1, 0)

df$male <- rep(subset(df, wave == 1)$male, 3)
df$usborn <- rep(subset(df, wave == 1)$usborn, 3)

write.csv(df, here("processed_data", "panel_data_munged.csv"))
```

# Summarize by group 

## Table 1 and 2

```{r}
var.list <- NULL
var.list <- names(df)[str_detect(names(df), "disc")][c(1, 3)]

var.list <- c(var.list, c("linkedfate", "idimport", "asnpride", "rona.behav.sneeze", "rona.behav.language", "rona.behav.walk", "rona.behav.transit", "rona.behav.other", "rona.behav.nochange", "rona.index", "X2020likelyvote", "biden", "DEM", "DEM.strong", "GOP", "GOP.strong"))
```

```{r message = FALSE}
group_sum <- purrr::map_dfr(seq(var.list), group_mean) %>%
    mutate(variable = rep(var.list, each = 3)) %>%
    filter(!is.na(mean)) 
```

```{r}
group_sum %>%
    filter(str_detect(variable, "disc")) %>%
    mutate(variable = recode(variable, 
                             "apa.discrim.rona" = "COVID-19 discrimination",
                             "gendiscrim" = 
                                 "General discrimination")) %>%
    ggplot(aes(x = factor(wave_fac), y = mean,
               ymax = mean + ci_high, 
               ymin = mean - ci_low)) +
        geom_pointrange() +
        ggrepel::geom_text_repel(aes(label = round(mean, 2))) +
        facet_wrap(~variable) +
        labs(title = "Changes in discrimination perception",
            x = "Wave", y = "Average response") +
        geom_hline(yintercept = 0.5,  linetype = 'dotted', col = 'red', size = 1)

ggsave(here("outputs", "disc.perception.png"))
```

```{r}
gen_density <- df %>%
  ggplot(aes(gendiscrim)) +
    geom_density() +
    facet_wrap(~wave_fac) +
    labs(x = "Response",
         y = "Density",
         title = "General discrimination") +
    geom_vline(xintercept = 0.5,  linetype = 'dotted', col = 'red', size = 1)

rona_density <- df %>%
  ggplot(aes(apa.discrim.rona)) +
    geom_density() +
    facet_wrap(~wave_fac) +
    labs(x = "Response",
         y = "Density",
         title = "COVID-19 discrimination") +
    geom_vline(xintercept = 0.5,  linetype = 'dotted', col = 'red', size = 1)

gen_density / rona_density

ggsave(here("outputs", "density.png"), width = 10)
```

```{r}
group_sum %>%
    filter(!str_detect(variable, "disc|rona|2020|biden|DEM|GOP")) %>%
    mutate(variable = recode(variable, 
                             "asnpride" = "Proud to be Asian",
                             "linkedfate" = 
                             "Linked fate",
                             "idimport" = "Asian identity important")) %>%
    ggplot(aes(x = factor(wave_fac), y = mean ,
               ymax = mean + ci_high, 
               ymin = mean - ci_low)) +
        geom_pointrange() +
        ggrepel::geom_text_repel(aes(label = round(mean, 2))) +
        facet_wrap(~variable) +
        labs(title = "Changes in group identity and consciousness",
            x = "Wave", y = "Average response") +
        geom_hline(yintercept = 0.5,  linetype = 'dotted', col = 'red', size = 1)

ggsave(here("outputs", "solidarity.perception.png"))
```

```{r}
group_sum %>%
    filter(wave_fac == "May") %>% 
    filter(str_detect(variable, "rona")) %>%
    filter(!str_detect(variable, "apa|nochange|2020|biden|DEM|GOP")) %>%
    mutate(variable = recode(variable, 
                             "rona.behav.sneeze" = "Avoid coughing/sneezing",
                             "rona.behav.language" = 
                             "Avoid speaking Asian language",
                             "rona.behav.walk" = "Avoid walking in neighborhoods",
                             "rona.behav.transit" = "Avoid public transporation",
                             "rona.behav.other" = "Others",
                             "rona.index" = "Average response")) %>%
  mutate(mean = mean*100) %>%
    ggplot(aes(x = factor(variable), y = mean,
               ymax = mean + ci_high, 
               ymin = mean - ci_low)) +
        geom_pointrange() +
        ggrepel::geom_text_repel(aes(label = round(mean, 2))) +
        labs(title = "COVID-19 related marginalized experience (Wave 2)",
            x = "", y = "Percentage") +
        coord_flip()

ggsave(here("outputs", "rona_behave.png"), width = 10)
```

```{r}
pol_bev_plot <- group_sum %>%
    filter(str_detect(variable, "2020|biden")) %>%
    filter(wave_fac != "February") %>%
    mutate(variable = recode(variable, 
                             "biden" = "Supporting Biden candidacy",
                             "X2020likelyvote" = "Will vote in 2020 election")) %>%
    ggplot(aes(x = factor(wave_fac), y = mean,
               ymax = mean + ci_high, 
               ymin = mean - ci_low)) +
        geom_pointrange() +
        ggrepel::geom_text_repel(aes(label = paste(round(mean, 2)*100, "%"))) +
        scale_y_continuous(labels = scales::percent) +
        facet_wrap(~variable) +
        labs(title = "Changes in political preferences",
            x = "Wave", y = "Percentage") 

pol_bev_plot
ggsave(here("outputs", "political_outcome.png"))
```

```{r}
pid_plot <- group_sum %>%
    filter(str_detect(variable, "GOP|DEM")) %>%
    filter(!str_detect(variable, "strong")) %>%
    mutate(variable = recode(variable, 
                             "biden" = "Supporting Biden candidacy",
                             "X2020likelyvote" = "Will vote in 2020 election")) %>%
    ggplot(aes(x = factor(wave_fac), y = mean,
               ymax = mean + ci_high, 
               ymin = mean - ci_low)) +
        geom_pointrange() +
        ggrepel::geom_text_repel(aes(label = paste(round(mean, 2)*100, "%"))) +
        scale_y_continuous(labels = scales::percent) +
        facet_wrap(~variable) +
        labs(title = "Changes in party identification",
            x = "Wave", y = "Percentage")

pid_plot
ggsave(here("outputs", "pid.png"))

pol_bev_plot + pid_plot

ggsave(here("outputs", "pol_bev.png"), width = 10)
```

## Table 3

```{r}
df$proxy <- rep(subset(df, wave == 1)$gendiscrim, 3)

plot_w12 <- df %>%
    filter(wave %in% c(1,2)) %>%
    group_by(proxy) %>%
    summarise(mean = mean(apa.discrim.rona, na.rm = TRUE),
                  ci_high = ci.high(apa.discrim.rona),
                  ci_low = ci.low(apa.discrim.rona)) %>%
    mutate(group = 2)

plot_w13 <- df %>%
    filter(wave %in% c(1,3)) %>%
    group_by(proxy) %>%
    summarise(mean = mean(apa.discrim.rona, na.rm = TRUE),
                  ci_high = ci.high(apa.discrim.rona),
                  ci_low = ci.low(apa.discrim.rona)) %>%
    mutate(group = 3)

plot_w123 <- bind_rows(plot_w12, plot_w13)
```

```{r}
plot_w123 %>%
    ggplot(aes(x = factor(proxy), y = mean,
               ymax = mean + ci_high, 
               ymin = mean - ci_low, 
               col = factor(group))) +
        geom_pointrange() +
        ggrepel::geom_text_repel(aes(label = round(mean, 2))) +
        labs(x = "Response to general discrimination Q in Wave 1", 
             y = "Average response to COVID-19 discrimination Q in Wave 2 and 3",
             col = "Wave") +
        geom_hline(yintercept = 0.5,  linetype = 'dotted', col = 'red', size = 1) 

ggsave(here("outputs", "disc.wave.png"), height = 9, width = 9)
```

# Regression analysis

## Likely to vote 

```{r}
lm.out <- lm(X2020likelyvote ~ gendiscrim + apa.discrim.rona + apa.discrim.rona:linkedfate + usborn + DEM + GOP + male + edu + factor(wave), data = df)

lm.robust.out <- estimatr::lm_robust(X2020likelyvote ~ gendiscrim + apa.discrim.rona + apa.discrim.rona:linkedfate + usborn + DEM + GOP + male + edu + factor(wave), data = df)

plm.out <- plm(X2020likelyvote ~ gendiscrim + apa.discrim.rona + usborn + apa.discrim.rona:linkedfate + DEM + GOP + male + edu + factor(wave), data = df,
               model = "fd", index = c("pid", "wave"))

lme.out <- lmer(X2020likelyvote ~ gendiscrim + apa.discrim.rona + apa.discrim.rona:linkedfate + usborn + DEM + GOP + male + edu + factor(wave) + (1|pid), data = df)

model.outs <- broom.mixed::tidy(lme.out, conf.int = TRUE) %>% 
  mutate(model = "Mixed") %>%
  dplyr::select(!matches("effect|group"))

model.outs <- bind_rows(
tidy(lm.out, conf.int = TRUE) %>%
  mutate(model = "Within estimator"),

tidy(lm.robust.out, conf.int = TRUE) %>%
  mutate(model = "Robust SE"),

tidy(plm.out, conf.int = TRUE) %>%
  mutate(model = "FD estimator"),

broom.mixed::tidy(lme.out, conf.int = TRUE) %>% 
  mutate(model = "Mixed model") %>%
  dplyr::select(!matches("effect|group")))
```

```{r}
model.outs %>%
  filter(!str_detect(term, "(Intercept)|sd")) %>%
  mutate(term = recode(term, 
                       "usborn1" = "Born in US",
                       "male1" = "Male",
                       "gendiscrim" = "General discrimination",
                       "apa.discrim.rona" = "COVID discrimination",
                       "edu" = "Education",
                       "factor(wave)3" = "Wave 3",
                       "GOP" = "Republican",
                       "DEM" = "Democrat",
                       "linkedfate:apa.discrim.rona" = "COVID discrimination:Linked fate")) %>%
  ggplot(aes(x = term, y = estimate, 
             ymax = conf.high, 
             ymin = conf.low)) +
    geom_pointrange() +
    coord_flip() +
    facet_wrap(~factor(model)) +
    geom_hline(yintercept = 0, linetype = "dotted", color = "red", size = 1)  +
    labs(y = "Estimate",
         x = "",
         title = "Likely to vote in 2020 election") +
    ggrepel::geom_text_repel(aes(label = round(estimate, 2)))

ggsave(here("outputs", "vote2020.png"), width = 10, 
       height = 10)
```

## Biden candidacy

```{r}
glm.out <- glm(biden ~ gendiscrim + apa.discrim.rona + apa.discrim.rona:linkedfate + usborn + GOP + DEM + male + edu + factor(wave), data = df, family = "binomial")

tidy(glm.out, conf.int = TRUE) %>%
  interpret_estimate() %>%
  mutate(term = recode(term, 
                       "usborn1" = "Born in US",
                       "male1" = "Male",
                       "gendiscrim" = "General discrimination",
                       "apa.discrim.rona" = "COVID discrimination",
                       "edu" = "Education",
                       "factor(wave)3" = "Wave 3",
                       "GOP" = "Republican",
                       "DEM" = "Democrat",
                       "apa.discrim.rona:linkedfate" = "COVID discrimination:Linked fate")) %>%
  filter(!str_detect(term, "(Intercept)")) %>%
  ggplot(aes(x = term, y = estimate, 
             ymax = conf.high, 
             ymin = conf.low)) +
    geom_pointrange() +
    coord_flip() +
    geom_hline(yintercept = 0, linetype = "dotted", color = "red", size = 1) +
    ggrepel::geom_text_repel(aes(label = round(estimate, 2))) +
    labs(y = "Estimate",
         x = "",
         title = "Suppporting Democratic Presidential candidate")

ggsave(here("outputs", "biden.png"), width = 8, height = 8)
```