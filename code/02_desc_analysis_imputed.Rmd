---
title: "Descriptive analysis (imputed)"
author: "Jae Yeon Kim"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

# Load packages 

```{r}
if (!require(pacman)) install.packages("pacman")

pacman::p_load(tidyverse, # tidyverse 
               panelr, # panel data analysis
               here, # computational reproducibility 
               glue, # gluing objects and strings 
               tidylog, # logging analysis
               naniar, # missing data 
               zeallot, # multiple assignments 
               readxl, 
               ggpubr,
               hrbrthemes, 
               broom, 
               jtools, 
               patchwork, 
               broom.mixed, 
               estimatr, 
               stargazer,
               DeclareDesign,
               sensemakr,
               mice,
               usmap,
               janitor,
               modelsummary)

source(here("functions/utils.r"))
```

# Load files 

```{r message = FALSE}
df <- read.csv(here("processed_data", "panel_data_cleaned.csv"))
```

# Regression analysis

## Imputation

```{r}
df_na_sum <- df %>%
  filter(wave != 1) %>%
  select(gendiscrim, apa.discrim.rona, usborn, party.id, age, male, edu, income) %>%
  map_dfr(~is.na(.) %>% mean())

df_na_sum
```

```{r}
imp <- mice(
  df %>%
    filter(wave != 1) %>%
    select(apa.discrim.rona, usborn, DEM, GOP, age, male, edu),
    seed = 1234, # for reproducibility
    m = 5, # the number of imputations
    maxit = 10, # the max number of iterations 
    method = "pmm", # predictive mean method
    print = FALSE)

densityplot(imp, layout = c(1,2))

imputed <- mice::complete(imp)

# Replace with the imputed values 
df$apa.discrim.rona[665:nrow(df)] <- 
imputed$apa.discrim.rona

df$DEM[665:nrow(df)] <- 
imputed$DEM

df$GOP[665:nrow(df)] <- 
imputed$GOP

df$age[665:nrow(df)] <- 
imputed$age
```

## Likely to vote 

```{r}
df$prior <- if_else(df$proxy <= 0.5 , 1, 0)

two.group <- bind_rows(tidy_test(usborn) %>% mutate(variable = "Born in US"),
  tidy_test(age) %>% mutate(variable = "Age"),
  tidy_test(male) %>% mutate(variable = "Male"),
  tidy_test(edu) %>% mutate(variable = "Education"),
  tidy_test(income) %>% mutate(variable = "Income"),
  tidy_test(GOP) %>% mutate(variable = "Republican"),
  tidy_test(DEM) %>% mutate(variable = "Democrat")
) 

two.group %>%
  ggplot(aes(x = variable, y = estimate, 
             ymax = conf.high,
             ymin = conf.low)) +
    geom_pointrange() +
    geom_hline(yintercept = 0, linetype = "dotted", color = "red", size = 1) +
    labs(x = "",
         y = "Estimate",
         title = glue("Estimate 1: Low and Middle (<=0.5)
                       Estimate 2: High (>0.5)"))
  
ggsave(here("outputs", "estimate.two.group_imputed.png"), width = 8)

two.group %>%
  ggplot(aes(x = variable, y = p.value)) +
    geom_point() +
    geom_hline(yintercept = 0.05, linetype = "dotted", color = "red", size = 1) +
    labs(x = "",
         y = "P value")
  
ggsave(here("outputs", "p.value.two.group_imputed.png"), width = 8)

```

```{r}
model.outs <- cal_model_outputs(df)
model.outs.low <- cal_model_outputs(df %>%
                                      filter(prior == 1))
model.outs.high <- cal_model_outputs(df %>%
                                      filter(prior != 1))
```

### Main 

```{r}
model.outs %>%
  filter(!str_detect(term, "(Intercept)|sd")) %>%
  mutate(term = recode(term, 
                       "usborn" = "Born in US",
                       "male" = "Male",
                       "gendiscrim" = "General discrimination",
                       "apa.discrim.rona" = "COVID discrimination",
                       "edu" = "Education",
                       "factor(wave)3" = "Wave 3",
                       "GOP" = "Republican",
                       "DEM" = "Democrat",
                       "age" = "Age",
                       "income" = "Income")) %>%
  ggplot(aes(x = term, y = estimate, 
             ymax = conf.high, 
             ymin = conf.low,
             col = model)) +
    geom_pointrange() +
    coord_flip() +
    geom_hline(yintercept = 0, linetype = "dotted", color = "red", size = 1)  +
    labs(y = "Estimate",
         x = "",
         col = "Model",
         title = "Likely to vote in 2020 election") +
    ggrepel::geom_text_repel(aes(label = round(estimate, 2))) +
    scale_colour_brewer(palette = "Set1") + theme(legend.position = "bottom")

ggsave(here("outputs", "vote2020_imputed.png"), width = 8, 
       height = 8)
```

### Sub

Only mixed model 

```{r}
model_outs_binded <- bind_rows(mutate(model.outs.high, group = "High"),
          mutate(model.outs.low, group = "Low and middle")          )

model_outs_binded %>%
  filter(!str_detect(term, "(Intercept)|sd")) %>%
  mutate(term = recode(term, 
                       "usborn" = "Born in US",
                       "male" = "Male",
                       "gendiscrim" = "General discrimination",
                       "apa.discrim.rona" = "COVID discrimination",
                       "edu" = "Education",
                       "factor(wave)3" = "Wave 3",
                       "GOP" = "Republican",
                       "DEM" = "Democrat",
                       "age" = "Age")) %>%
  ggplot(aes(x = term, y = estimate, 
             ymax = conf.high, 
             ymin = conf.low,
             col = model)) +
    geom_pointrange() +
    coord_flip() +
    facet_wrap(~factor(group)) +
    geom_hline(yintercept = 0, linetype = "dotted", color = "red", size = 1)  +
    labs(y = "Estimate",
         x = "",
         title = "Likely to vote in 2020 election",
         col = "Group") +
    ggrepel::geom_text_repel(aes(label = round(estimate, 2))) +
    theme(legend.position = "bottom")

ggsave(here("outputs", "vote2020_sub_imputed.png"), width = 8, 
       height = 8)
```

## Biden candidacy

### Main 

```{r}
model.outs <- cal_glm(df)
```

```{r}
model.outs %>%
  filter(str_detect(model, "Within estimator")) %>%
  filter(!str_detect(term, "(Intercept)")) %>%
  ggplot(aes(x = term, y = estimate, 
             ymax = conf.high, 
             ymin = conf.low)) +
    geom_pointrange() +
    coord_flip() +
    geom_hline(yintercept = 0, linetype = "dotted", color = "red", size = 1) +
    ggrepel::geom_text_repel(aes(label = round(estimate, 2))) +
    labs(y = "Estimate",
         x = "",
         title = "Suppporting Democratic Presidential candidate") +
    theme(legend.position = "bottom")

ggsave(here("outputs", "biden_imputed.png"))
```

### Sub

```{r}
glm_outs_binded <- bind_rows(
mutate(cal_glm(df %>% filter(prior != 1)), group = "High"), 
mutate(cal_glm(df %>% filter(prior == 1)), group = "Low and Middle"))

glm_outs_binded %>%
  filter(str_detect(model, "Within estimator")) %>%
  filter(!str_detect(term, "(Intercept)")) %>%
  ggplot(aes(x = term, y = estimate, 
             ymax = conf.high, 
             ymin = conf.low)) +
    geom_pointrange() +
    coord_flip() +
    geom_hline(yintercept = 0, linetype = "dotted", color = "red", size = 1) +
    ggrepel::geom_text_repel(aes(label = round(estimate, 2))) +
    facet_wrap(~group) +
    labs(y = "Estimate",
         x = "",
         title = "Suppporting Democratic Presidential candidate")

ggsave(here("outputs", "biden_sub_imputed.png"))
```