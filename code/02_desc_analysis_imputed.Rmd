---
title: "Descriptive analysis (imputed)"
author: "Jae Yeon Kim"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

# Load packages 

```{r}
if (!require(pacman)) install.packages("pacman")

pacman::p_load(tidyverse, # tidyverse 
               panelr, # panel data analysis
               here, # computational reproducibility 
               glue, # gluing objects and strings 
               tidylog, # logging analysis
               naniar, # missing data 
               zeallot, # multiple assignments 
               readxl, 
               ggpubr,
               hrbrthemes, 
               wesanderson,
               broom, 
               jtools, 
               patchwork, 
               broom.mixed, 
               estimatr, 
               stargazer,
               DeclareDesign,
               sensemakr,
               mice,
               usmap,
               janitor,
               modelsummary)

source(here("functions/utils.r"))

ggplot2::theme_set(ggpubr::theme_pubclean())

# no scientific notation
options(scipen = 999)
```

# Load files 

```{r message = FALSE}
df <- read.csv(here("processed_data", "panel_data_cleaned.csv"))
```

# Regression analysis

## Imputation

```{r}
df_na_sum <- df %>%
  filter(wave != 1) %>%
  select(X2020likelyvote, biden, gendiscrim, apa.discrim.rona, usborn, edu, income, DEM, GOP, age, male, wave, korean, japanese) %>%
  map_dfr(~is.na(.) %>% mean())

df_na_sum
```

```{r}
imp <- mice(
  df %>%
    filter(wave != 1) %>%
    select(gendiscrim, apa.discrim.rona, usborn, edu, income, DEM, GOP, age, male, wave, korean, japanese),
    seed = 1234, # for reproducibility
    m = 5, # the number of imputations
    maxit = 10, # the max number of iterations 
    method = "pmm", # predictive mean method
    print = FALSE)

densityplot(imp, layout = c(1,2))

imputed <- mice::complete(imp)
```

```{r}
# Replace with the imputed values 
df$apa.discrim.rona[665:nrow(df)] <- 
imputed$apa.discrim.rona

df$gendiscrim[665:nrow(df)] <- 
imputed$gendiscrim

df$DEM[665:nrow(df)] <- 
imputed$DEM

df$GOP[665:nrow(df)] <- 
imputed$GOP

df$age[665:nrow(df)] <- 
imputed$age
```

## Likely to vote 

```{r}
df$proxy <- rep(subset(df, wave == 1)$gendiscrim, 3)
df$prior[df$proxy == 0.5] <- "Middle"
df$prior[df$proxy < 0.5] <- "Low"
df$prior[df$proxy > 0.5] <- "High"
```

```{r}
model.outs <- cal_model_outputs(df)
model.outs.low <- cal_model_outputs(df %>%
                                      filter(prior == "Low"))
model.outs.middle <- cal_model_outputs(df %>%
                                      filter(prior == "Middle"))
model.outs.high <- cal_model_outputs(df %>%
                                      filter(prior == "High"))
```

### Main 

```{r}
models <- list(

"Model 1" = lm(X2020likelyvote ~ gendiscrim + apa.discrim.rona + factor(wave), data = df),

"Model 2" = lm(X2020likelyvote ~ gendiscrim + apa.discrim.rona + usborn + edu + income + DEM + GOP + age + male + factor(wave), data = df),

"Model 3" = lm(X2020likelyvote ~ gendiscrim + apa.discrim.rona + usborn + edu + income + DEM + GOP + age + male + factor(wave) + korean + japanese, data = df))

modelsummary(models,
             fmt = 3,
             coef_omit = "Intercept",
             statistic = c("p = {p.value}"),
             stars = TRUE, 
             output = here("outputs", "reg_tb1.docx"),
             coef_rename = 
                 c("gendiscrim" = "General discrimination",
                   "apa.discrim.rona" = "COVID-19 discrimination",
                   "usborn" = "US born",
                   "edu" = "Education",
                   "income" = "Income",
                   "DEM" = "DEM",
                   "GOP" = "GOP",
                   "age" = "Age",
                   "male" = "Male",
                   "factor(wave)3" = "Wave3",
                   "korean" = "Korean",
                   "japanese" = "Japanese"),
             vcov = "HC2",
             cluster = "state")
```

```{r}
sense.out <- sensemakr(model = lm(X2020likelyvote ~ gendiscrim + apa.discrim.rona + usborn + edu + income + DEM + GOP + age + male + factor(wave) + korean + japanese, data = df),
          treatment = "apa.discrim.rona", 
          benchmark_covariates = "usborn",
          kd = 1:3, 
          ky = 1:3, 
          q = 1)

summary(sense.out)
```

### Sub

```{r}
sub.models <- list(
"High Discrimination Pre-COVID" = lm(X2020likelyvote ~ gendiscrim + apa.discrim.rona + usborn + edu + income + DEM + GOP + age + male + factor(wave) + korean + japanese, data = subset(df, prior == "High")),
            
"Middle Discrimination Pre-COVID" = lm(X2020likelyvote ~ gendiscrim + apa.discrim.rona + usborn + edu + income + DEM + GOP + age + male + factor(wave) + korean + japanese, data = subset(df, prior == "Middle")),
            
"Low Discrimination Pre-COVID" = lm(X2020likelyvote ~ gendiscrim + apa.discrim.rona + usborn + edu + income + DEM + GOP + age + male + factor(wave) + korean + japanese, data = subset(df, prior == "Low")))

modelsummary(sub.models,
             fmt = 3,
             coef_omit = "Intercept",
             statistic = c("p = {p.value}"),
             stars = TRUE, 
             output = here("outputs", "reg_tb_sub1.docx"),
             coef_rename = 
                 c("gendiscrim" = "General discrimination",
                   "apa.discrim.rona" = "COVID-19 discrimination",
                   "usborn" = "US born",
                   "edu" = "Education",
                   "income" = "Income",
                   "DEM" = "DEM",
                   "GOP" = "GOP",
                   "age" = "Age",
                   "male" = "Male",
                   "factor(wave)3" = "Wave3",
                   "korean" = "Korean",
                   "japanese" = "Japanese"),
             vcov = "HC2",
             cluster = "state")
```

## Biden candidacy

### Main 

```{r}
biden.models <- list(

"Model 1" = glm(biden ~ gendiscrim + apa.discrim.rona + factor(wave), data = df, family = binomial),

"Model 2" = glm(biden ~ gendiscrim + apa.discrim.rona + usborn + edu + income + DEM + GOP + age + male + factor(wave), data = df, family = binomial),

"Model 3" = glm(biden ~ gendiscrim + apa.discrim.rona + usborn + edu + income + DEM + GOP + age + male + factor(wave) + korean + japanese, data = df, family = binomial))

modelsummary(biden.models,
             exponentiate = TRUE,
             fmt = 3,
             coef_omit = "Intercept",
             statistic = c("p = {p.value}"),
             stars = TRUE, 
             output = here("outputs", "reg_tb2.docx"),
             coef_rename = 
                 c("gendiscrim" = "General discrimination",
                   "apa.discrim.rona" = "COVID-19 discrimination",
                   "usborn" = "US born",
                   "edu" = "Education",
                   "income" = "Income",
                   "DEM" = "DEM",
                   "GOP" = "GOP",
                   "age" = "Age",
                   "male" = "Male",
                   "factor(wave)3" = "Wave3",
                   "korean" = "Korean",
                   "japanese" = "Japanese"),
             vcov = c("HC0"),
             cluster = "state")

sense.out.biden <- sensemakr(model = lm(biden ~ gendiscrim + apa.discrim.rona + usborn + edu + income + DEM + GOP + age + male + factor(wave) + korean + japanese, data = df),
          treatment = "apa.discrim.rona", 
          benchmark_covariates = "usborn",
          kd = 1:3, 
          ky = 1:3, 
          q = 1)

summary(sense.out.biden)

lm(biden ~ gendiscrim + apa.discrim.rona + usborn + edu + income + DEM + GOP + age + male + factor(wave) + korean + japanese, data = df)
```

### Sub

```{r}
sub.models <- list(
"High Discrimination Pre-COVID" = glm(biden ~ gendiscrim + apa.discrim.rona + usborn + edu + income + DEM + GOP + age + male + factor(wave) + korean + japanese, data = subset(df, prior == "High"), family = binomial),
            
"Middle Discrimination Pre-COVID" = glm(X2020likelyvote ~ gendiscrim + apa.discrim.rona + usborn + edu + income + DEM + GOP + age + male + factor(wave) + korean + japanese, data = subset(df, prior == "Middle"), family = binomial),
            
"Low Discrimination Pre-COVID" = glm(X2020likelyvote ~ gendiscrim + apa.discrim.rona + usborn + edu + income + DEM + GOP + age + male + factor(wave) + korean + japanese, data = subset(df, prior == "Low"), family = binomial))

modelsummary(sub.models,
             exponentiate = TRUE,
             fmt = 3,
             coef_omit = "Intercept",
             statistic = c("p = {p.value}"),
             stars = TRUE, 
             output = here("outputs", "reg_tb_sub2.docx"),
             coef_rename = 
                 c("gendiscrim" = "General discrimination",
                   "apa.discrim.rona" = "COVID-19 discrimination",
                   "usborn" = "US born",
                   "edu" = "Education",
                   "income" = "Income",
                   "DEM" = "DEM",
                   "GOP" = "GOP",
                   "age" = "Age",
                   "male" = "Male",
                   "factor(wave)3" = "Wave3",
                   "korean" = "Korean",
                   "japanese" = "Japanese"),
             vcov = "HC0",
             cluster = "state")
```

## Subgroup summary 

```{r}
modelplot(lm(gendiscrim ~ usborn + edu + income + DEM + GOP + age + male, data = subset(df, wave == 1)),
          coef_omit = "Intercept",
          vcov = "HC2",
          coef_rename = 
                 c("usborn" = "US born",
                   "edu" = "Education",
                   "income" = "Income",
                   "DEM" = "Democratic Party",
                   "GOP" = "Republican Party",
                   "age" = "Age",
                   "male" = "Male")) +
    geom_vline(xintercept = 0, col = "red", linetype = "dashed")

ggsave(here("outputs", "correlate.png"))
```