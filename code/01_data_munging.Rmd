---
title: "Data analysis"
author: "Jae Yeon Kim"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

# Load packages 

```{r}
if (!require(pacman)) install.packages("pacman")

pacman::p_load(tidyverse, # tidyverse 
               panelr, # panel data analysis
               here, # computational reproducibility 
               glue, # gluing objects and strings 
               tidylog, # logging analysis
               naniar, # missing data 
               zeallot, # multiple assignments 
               readxl)

source(here("functions/utils.r"))
```

# Tidying 

## Load and merge data 

```{r message = FALSE}
# Check the file names
# list.files(here("raw_data"))
w1 <- read_csv(here("raw_data/wave1.csv"))[-c(1:2),]
w2 <- read_csv(here("raw_data/wave2.csv"))[-c(1:2),]
w3 <- readxl::read_xls(here("raw_data/wave3_alt.xls"))[-c(1:2),]
```

```{r message = FALSE}
codebook <- read_csv(here("raw_data/codebook_alt.csv"))

# Check dimensions 
ncol(w1) == nrow(subset(codebook, wave == "w1"))
ncol(w2) == nrow(subset(codebook, wave == "w2"))
ncol(w3) == nrow(subset(codebook, wave == "w3"))
```

```{r}
# make unique variations of drop variable 
codebook$alt_name[grepl("drop", codebook$alt_name)] <- make.unique(codebook$alt_name[grepl("drop", codebook$alt_name)], sep = "_")
```

## Change column names 

```{r message = FALSE}
names(w1) <- subset(codebook, wave == "w1")$alt_name
names(w2) <- subset(codebook, wave == "w2")$alt_name
names(w3) <- subset(codebook, wave == "w3")$alt_name
```

## Drop "drop_" columns 

```{r}
w1 <- w1 %>% select(!contains("drop"))
w2 <- w2 %>% select(!contains("drop"))
w3 <- w3 %>% select(!contains("drop"))
```

## Add missing variables in each wave

```{r}
# Check
names(w1)[str_detect(names(w1), "disc")]
# "gendiscrim" "expdiscrim"
names(w2)[str_detect(names(w2), "disc")]
# [1] "apa.discrim.rona" "apa.discrim.who" 
# [3] "gendiscrim" 
names(w3)[str_detect(names(w3), "disc")]
# [1] "apa.discrim.rona"     "civic.engage.discuss"
# [3] "gendiscrim"           "job.discrim"    
# [5] "work.discrim"         "police.discrim" 
# [7] "housing.discrim"      "restaurant.discrim" 
```
```{r}
w1 <- add_miss_cols(w1, w2)
w3 <- add_miss_cols(w3, w2)
w3 <- add_miss_cols(w3, w1)

# Check
unique(w1$party.id)
# 1 == Independent 
# 2 == Democrat 
# 3 == Republican
unique(w2$party.id) 
# 1 == Republican 
# 2 == Independent 
# 3 == Democrat 
# 4 == Some other party
# 5 == I don't know 
unique(w3$party.id)
# 1 == Republican 
# 2 == Independent 
# 3 == Democrat 
# 4 == Some other party
# 5 == I don't know 
```

## Add an wave identifier 

```{r}
names(w1) <- glue("W1_{names(w1)}")
names(w2) <- glue("W2_{names(w2)}")
names(w3) <- glue("W3_{names(w3)}")
```

## Merge dataframes 

```{r}
# Inner join
w12 <- inner_join(w1, w2, by = c("W1_respondent.id" = "W2_respondent.id"))

w13 <- inner_join(w1, w3, by = c("W1_pid" = "W3_pid"))

# Rename ID columns 
w12 <- w12 %>%
  rename("id" = "W1_respondent.id") 

w13 <- w13 %>%
  rename("id" = "W1_pid") 

# Remove duplicates 
w12 <- w12[!duplicated(w12$id),]
w13 <- w13[!duplicated(w13$id),]
```

## Find common quuestions 

```{r}
# Wave 1 and 2
common.q12 <- intersect(extract_name(w12, "W1"), 
extract_name(w12, "W2"))

long12 <- w12 %>%
  select(matches(common.q12) | id) %>%
  long_panel(prefix = "W", suffix = "_", 
             begin = 1, end = 2, 
             label_location = "beginning")

# Wave 1 and 2
common.q13 <- intersect(extract_name(w13, "W1"), 
extract_name(w13, "W3"))

long13 <- w13 %>%
  select(matches(common.q13) | id) %>%
  long_panel(prefix = "W", suffix = "_", 
             begin = 1, end = 3, 
             label_location = "beginning")
```

## Final merging 

```{r}
long_complete <- left_join(long13, long12) %>%
  dplyr::select(!matches("response|respondent|pid"))

# Check how many variables were added to each wave
long_complete %>%
  data.frame() %>%
  group_by(wave) %>%
  miss_var_summary() %>%
  filter(pct_miss == 100) %>%
  count(wave) %>%
  ggplot(aes(x = wave, y = n)) +
    geom_col()

# Fill in missing values using the previous wave information

# Target variables
vars <- c("race", "gender", "natorigin", "usborn")

# Creating the code for copying and pasting programmatically
glue("long_complete <- fill(long_complete, {vars})")

long_complete <- fill(long_complete, race)
long_complete <- fill(long_complete, gender)
long_complete <- fill(long_complete, natorigin)
long_complete <- fill(long_complete, usborn)
```


```{r}
# 1992 obs and 76 variables 
dim(long_complete)

write.csv(long_complete, here("processed_data/panel_data.csv"))
```

## Calculate attrition rate 

$\textrm{Attrition rate} = \frac{\textrm{# of pre_wave participants} - \textrm{# of post_wave participants}}{\textrm{# pre_wave participants}}$

```{r}
attr_rate <- function(pre, post) {
    out <- (pre - post)/pre 
    round(out, 2)}

glue("The attrition rate between w1 and w2 is: {attr_rate({nrow(w1)}, nrow(w12)) * 100}%")
glue("The attrition rate between w2 and w3 is: {attr_rate(nrow(w12), nrow(w13)) * 100}%")
```

# Munging

Make a copy 

```{r}
df <- long_complete
```

## Replace 9999 with NA

```{r}
df <- na_if(df, 9999)
```

## Recode values 

```{r}
# Discrimination against Asians
df1 <- subset(df, wave == 1) 
df23 <- subset(df, wave != 1)

# Party ID
df1$party.id <- recode_party_w1(df1$party.id)
df23$party.id <- recode_party_w23(df23$party.id)

df <- bind_rows(df1, df23)

# Create dummy variables: gender, usborn
c(df$gender, df$usborn) %<-% map(list(df$gender, df$usborn), recode_dummy)

# Check 
unique(df$party.id) %in% c("Republican", "Independent", "Democrat", NA) == TRUE
```

# Export data 

```{r}
write_csv(df, here("processed_data", "panel_data_cleaned.csv"))
```